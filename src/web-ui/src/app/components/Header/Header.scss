/**
 * Header component styles (SCSS).
 * Follows the SCSS isolation strategy.
 */

@use '../../../component-library/styles/tokens' as tokens;
@use '../../../component-library/styles/_extended-mixins' as mix;

// ==================== Component private variables ====================

$_header-gap: tokens.$size-gap-3;
$_header-gap-sm: tokens.$size-gap-2;
$_panel-btn-size: 18px;
$_panel-btn-size-mobile: 16px;
$_panel-btn-size-small: 14px;
$_panel-btn-font-size: 11px;
$_app-icon-size: 20px;

// ==================== Header startup mode ====================
// When no workspace is open, hide most elements and keep window controls only

.bitfun-app-header--startup-mode {
  // Keep background unchanged
  background: var(--color-bg-primary) !important;
  border-bottom: 1px dashed var(--border-subtle) !important;
  
  // Hide AgentOrb (use opacity instead of display for animation support)
  .agent-orb-wrapper {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.5);
  }
  
  // Hide menu area
  .bitfun-menu-expand-area {
    opacity: 0;
    pointer-events: none;
  }
  
  // Hide center area
  .bitfun-header-center {
    opacity: 0;
    pointer-events: none;
  }
  
  // Hide right-side buttons (keep window controls)
  .bitfun-header-right {
    // Hide panel toggle group
    .bitfun-immersive-panel-toggles {
      opacity: 0;
      pointer-events: none;
    }
    
    // Hide config and related buttons
    > button {
      opacity: 0;
      pointer-events: none;
    }
  }
  
  // Keep window controls visible
  .window-controls {
    display: flex !important;
    opacity: 1 !important;
  }
  
  // Expand drag region to fill empty space
  .bitfun-header-left {
    flex: 1;
  }
  
  // ==================== Transition overrides ====================
  // When both --startup-mode and --transitioning are present, animate elements in
  &.bitfun-app-header--transitioning {
    // Switch border to solid
    border-bottom: 1px solid var(--border-subtle) !important;
    
    // Animate AgentOrb appearance after sweep
    .agent-orb-wrapper {
      pointer-events: auto;
      animation: header-orb-appear 500ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
      animation-delay: 450ms;
    }
    
    // Fade in menu area
    .bitfun-menu-expand-area {
      pointer-events: auto;
      animation: header-element-fade-in 300ms ease-out both;
      animation-delay: 550ms;
    }
    
    // Fade in center title area
    .bitfun-header-center {
      pointer-events: auto;
      animation: header-element-fade-in 280ms ease-out both;
      animation-delay: 600ms;
    }
    
    // Fade in right-side buttons
    .bitfun-header-right {
      .bitfun-immersive-panel-toggles {
        pointer-events: auto;
        animation: header-element-fade-in 280ms ease-out both;
        animation-delay: 650ms;
      }
      
      > button {
        pointer-events: auto;
        animation: header-element-fade-in 250ms ease-out both;
        animation-delay: 700ms;
      }
    }
  }
}

// Header transition keyframes
@keyframes header-orb-appear {
  0% {
    opacity: 0;
    transform: scale(2);
    filter: blur(8px);
  }
  30% {
    opacity: 0.9;
    transform: scale(1.3);
    filter: blur(3px);
  }
  60% {
    opacity: 1;
    transform: scale(0.9);
    filter: blur(0);
  }
  100% {
    opacity: 1;
    transform: scale(1);
    filter: blur(0);
  }
}

@keyframes header-element-fade-in {
  0% {
    opacity: 0;
    transform: translateY(-5px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

// ==================== Header layout ====================

// Header orb hover - Agentic mode (icy-blue border breathing)
// Use combined selectors to override the default bitfun-app-header ::after
.bitfun-header--orb-glow-agentic.bitfun-app-header,
.bitfun-header--orb-glow-agentic {
  &::after {
    content: '';
    position: absolute;
    inset: 0;
    background: transparent !important;
    pointer-events: none;
    z-index: 1;
    animation: header-border-breathe-ice 2.5s ease-in-out infinite !important;
    width: 100% !important;
    left: 0 !important;
  }

  // Buttons and icons echo the icy-blue tone
  .bitfun-agent-menu-btn,
  .bitfun-horizontal-menu-item,
  .bitfun-immersive-toggle-btn,
  .bitfun-panel-indicator,
  .bitfun-header-right > button,
  .window-controls__btn {
    color: rgba(100, 180, 255, 0.7);
    
    &:hover {
      color: rgba(100, 180, 255, 0.9);
    }
  }

  // Session title echoes the icy-blue tone
  .bitfun-current-session-title {
    .bitfun-current-session-title__text {
      color: rgba(100, 180, 255, 0.8);
    }
    
    .bitfun-current-session-title__create-btn {
      color: rgba(100, 180, 255, 0.6);
      
      &:hover {
        color: rgba(100, 180, 255, 0.9);
      }
    }
  }

  // Divider styling
  .bitfun-panel-divider,
  .bitfun-horizontal-menu-divider {
    background: rgba(100, 180, 255, 0.3);
  }

  // Special handling for window control buttons
  .window-controls__btn {
    svg {
      stroke: rgba(100, 180, 255, 0.7);
    }
    
    &:hover svg {
      stroke: rgba(100, 180, 255, 0.9);
    }
  }
}

// Header orb hover - Editor mode (theme-colored border breathing)
// Use combined selectors to override the default bitfun-app-header ::after
.bitfun-header--orb-glow-editor.bitfun-app-header,
.bitfun-header--orb-glow-editor {
  &::after {
    content: '';
    position: absolute;
    inset: 0;
    background: transparent !important;
    pointer-events: none;
    z-index: 1;
    animation: header-border-breathe-theme 2.5s ease-in-out infinite !important;
    width: 100% !important;
    left: 0 !important;
  }

  // Buttons and icons use theme colors via CSS variables
  .bitfun-agent-menu-btn,
  .bitfun-horizontal-menu-item,
  .bitfun-immersive-toggle-btn,
  .bitfun-panel-indicator,
  .bitfun-header-right > button,
  .window-controls__btn {
    color: var(--color-text-secondary);
    
    &:hover {
      color: var(--color-text-primary);
    }
  }

  // Global search follows theme colors with border breathing
  .bitfun-global-search {
    animation: search-border-breathe-theme 2.5s ease-in-out infinite;
    
    &:focus-within {
      animation: none;
      border-color: var(--border-strong);
      box-shadow: 0 0 0 1px var(--border-subtle);
    }
    
    .search__input {
      color: var(--color-text-primary);
      
      &::placeholder {
        color: var(--color-text-muted);
      }
    }
    
    .bitfun-global-search__option {
      color: var(--color-text-secondary);
      
      &:hover, &.active {
        color: var(--color-text-primary);
      }
    }
  }

  // Divider styling
  .bitfun-panel-divider,
  .bitfun-horizontal-menu-divider {
    background: var(--border-medium);
  }

  // Special handling for window control buttons
  .window-controls__btn {
    svg {
      stroke: var(--color-text-secondary);
    }
    
    &:hover svg {
      stroke: var(--color-text-primary);
    }
  }
}

// Agentic mode - icy-blue border breathing (bottom edge only)
@keyframes header-border-breathe-ice {
  0%, 100% {
    box-shadow: inset 0 -0.5px 0 0 rgba(100, 180, 255, 0.15);
  }
  50% {
    box-shadow: inset 0 -0.5px 0 0 rgba(100, 180, 255, 0.5);
  }
}

// Editor mode - theme border breathing (bottom edge only, neutral gray)
@keyframes header-border-breathe-theme {
  0%, 100% {
    box-shadow: inset 0 -0.5px 0 0 rgba(150, 150, 160, 0.2);
  }
  50% {
    box-shadow: inset 0 -0.5px 0 0 rgba(150, 150, 160, 0.6);
  }
}

// Editor mode - search box border breathing animation
@keyframes search-border-breathe-theme {
  0%, 100% {
    border-color: rgba(150, 150, 160, 0.15);
  }
  50% {
    border-color: rgba(150, 150, 160, 0.45);
  }
}

// Header startup sweep animation moved to AppLayout.scss
// Header left area
.bitfun-header-left {
  @include mix.flex-layout(row, center, start, $_header-gap);
  flex: 0 0 auto; // Fixed width, no expansion
  min-width: 0;
  position: relative;
  z-index: tokens.$z-decoration;
}

// Menu container: hover region for button and menu items
.bitfun-menu-container {
  @include mix.flex-layout(row, center, start, 8px); // Space between cube and menu button
  position: relative;
  padding: 4px; // Extend hit area to prevent menu flicker across gaps
  margin: -4px; // Offset padding to keep visual position stable
  border-radius: tokens.$size-radius-sm;
}

// Menu expand area: contains button and expanded items
// Entire area responds to hover to keep menu open
.bitfun-menu-expand-area {
  @include mix.flex-layout(row, center, start, 0); // Remove spacing for a tighter layout
  position: relative;
  padding: 4px; // Expand hover area
  margin: -4px; // Offset padding to keep position stable
  border-radius: tokens.$size-radius-sm;
}

// Orb menu button
.bitfun-agent-menu-btn {
  @include mix.reset-button;
  @include mix.flex-layout(row, center, center);
  width: 24px;
  height: 24px;
  border-radius: tokens.$size-radius-sm;
  background: transparent;
  color: var(--color-text-secondary); // Use CSS variables
  @include mix.transition(all, tokens.$motion-fast);
  cursor: pointer;
  border: none; // Remove border for a cleaner look
  position: relative;
  
  &:hover {
    background: var(--element-bg-soft); // Use CSS variables
    color: var(--color-text-primary); // Use CSS variables
    transform: translateY(-1px);
  }

  &:active {
    transform: translateY(0);
    background: var(--element-bg-medium); // Use CSS variables
  }

  // Pinned state
  &--pinned {
    background: var(--element-bg-soft); // Use CSS variables
    color: var(--color-text-primary); // Use CSS variables
  }
}

// ==================== Horizontal expanded menu ====================

// Horizontal menu container: fully blended into the header
.bitfun-horizontal-menu {
  @include mix.flex-layout(row, center, start, 4px); // Spacing between items
  position: absolute; // Absolute positioning
  left: 28px; // Align to menu button (~28px width)
  top: 50%;
  transform: translateY(-50%); // Vertically center
  height: auto;
  padding: 0; // Remove padding for a flatter look
  background: transparent; // Fully transparent to blend in
  border: none; // Remove border
  border-radius: 0; // Remove rounding
  box-shadow: none; // Remove shadow
  backdrop-filter: none; // Remove blur
  z-index: tokens.$z-decoration; // Lower z-index to align with header elements
  overflow: hidden;
  max-width: 0;
  opacity: 0;
  @include mix.transition(all, tokens.$motion-base);
  pointer-events: none;
  white-space: nowrap; // Prevent wrapping

  &--visible {
    max-width: 500px; // Cap width to avoid overrun
    opacity: 1;
    pointer-events: auto;
  }
}

// Horizontal menu item
.bitfun-horizontal-menu-item {
  @include mix.reset-button;
  @include mix.flex-layout(row, center, center, 5px); // Icon/text spacing
  padding: 4px 10px; // Padding
  border-radius: tokens.$size-radius-sm;
  background: transparent;
  color: var(--color-text-secondary); // Use CSS variables
  font-size: tokens.$font-size-xs;
  font-weight: 500;
  white-space: nowrap;
  cursor: pointer;
  border: none;
  @include mix.transition(all, tokens.$motion-fast);
  transform: translateX(-8px); // Slide in from left
  opacity: 0;
  flex-shrink: 0;
  
  // Icon
  svg {
    flex-shrink: 0;
  }

  // Label
  &__label {
    flex-shrink: 0;
  }

  // Expand items when menu is visible
  .bitfun-horizontal-menu--visible & {
    transform: translateX(0);
    opacity: 1;
  }

  &:hover {
    background: var(--element-bg-soft); // Use CSS variables
    color: var(--color-text-primary); // Use CSS variables
    transform: translateX(0) translateY(-1px);
  }

  &:active {
    transform: translateX(0) translateY(0);
    background: var(--element-bg-medium); // Use CSS variables
  }
}

// Horizontal menu divider
.bitfun-horizontal-menu-divider {
  width: 1px;
  height: 20px; // Increased height
  background: var(--border-subtle); // Use CSS variables
  opacity: 0;
  flex-shrink: 0;
  @include mix.transition(opacity, tokens.$motion-fast);
  
  // Show divider when menu is visible
  .bitfun-horizontal-menu--visible & {
    opacity: 0.3; // Lower opacity to blend in
  }
}

// Header center area: absolute positioning for true centering
.bitfun-header-center {
  @include mix.flex-layout(row, center, center);
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  transform: translateX(-50%);
  width: 100%;
  max-width: 600px; // Fixed max width for stable layout
  min-width: 0;
  padding: 0 $_header-gap;
  z-index: tokens.$z-content;
  overflow: visible; // Allow content to render outside
  pointer-events: none; // Center container ignores events
  @include mix.transition(none); // Disable transitions for stability
  
  // Re-enable events for children
  > * {
    pointer-events: auto;
  }

  // Remove menu-expanded offset; center stays centered
  // Menu floats via absolute positioning without affecting center
}

// Header right area
.bitfun-header-right {
  @include mix.flex-layout(row, center, end, 6px); // Tighter button spacing
  flex: 0 0 auto; // Fixed width, no expansion
  margin-left: auto; // Push to the far right
  margin-right: calc(-1 * #{tokens.$size-gap-4} + 4px); // Offset header padding with a small margin
  position: relative;
  z-index: tokens.$z-decoration;
}

// macOS native titlebar: add right padding to avoid edge clipping
.bitfun-app-header--macos-native-titlebar {
  .bitfun-header-right {
    margin-right: tokens.$size-gap-3;
  }
}

// ==================== Logo menu ====================

// Logo menu container (menu uses the new system)
.bitfun-logo-menu-container {
  position: relative;
  display: inline-block;
}

// ==================== View mode toggle ====================

.bitfun-view-mode-toggle {
  @include mix.flex-layout(row, center, start, 2px);
  padding: 2px;
  background: tokens.$element-bg-subtle;
  border-radius: tokens.$size-radius-sm;
  border: 1px solid tokens.$border-subtle;
  margin-left: $_header-gap;
}

.bitfun-view-mode-btn {
  @include mix.reset-button;
  @include mix.flex-layout(row, center, center);
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  color: tokens.$color-text-secondary;
  background: transparent;
  @include mix.transition(all, tokens.$motion-fast);
  cursor: pointer;
  white-space: nowrap;

  &:hover {
    color: tokens.$color-text-primary;
    background: tokens.$element-bg-soft;
  }

  &--active {
    color: tokens.$color-text-primary;
    background: tokens.$element-bg-medium;
    font-weight: 600;
    box-shadow: tokens.$shadow-xs;

    &:hover {
      background: tokens.$element-bg-medium;
    }
  }

  &:active {
    transform: scale(0.98);
  }
}

// ==================== App title button ====================

.bitfun-app-title-btn {
  @include mix.reset-button;
  @include mix.flex-layout(row, center, center);
  padding: tokens.$size-gap-1 $_header-gap-sm;
  border-radius: tokens.$size-radius-sm;
  background: transparent;
  color: tokens.$color-text-secondary;
  @include mix.transition(all);
  position: relative;
  overflow: hidden;
  border: 1px solid transparent;
  
  // Light sweep effect: inline and theme-aware
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
      transparent,
      var(--element-bg-subtle),
      var(--element-bg-soft),
      var(--element-bg-subtle),
      transparent
    );
    @include mix.transition(left, tokens.$motion-slow);
    border-radius: inherit;
  }
  
  &:hover::before {
    left: 100%;
  }

  &:hover {
    transform: translateY(-1px);
    background: transparent;
    border-color: transparent;
    box-shadow: tokens.$shadow-xs;
    color: tokens.$color-text-primary;
  }

  &:active {
    transform: translateY(0);
    box-shadow: tokens.$shadow-xs;
  }
}

// App icon
.bitfun-app-icon {
  @include mix.size($_app-icon-size);
}

// App title text
.bitfun-app-title {
  font-size: tokens.$font-size-xs;
  font-weight: tokens.$font-weight-bold;
  color: tokens.$color-text-primary;
  text-shadow: tokens.$shadow-xs;
  @include mix.transition(all);
}

// ==================== Immersive panel toggles ====================

.bitfun-immersive-panel-toggles {
  @include mix.flex-layout(row, center, start, 1px);
  margin-right: 4px; // Reduce right margin to sit closer to config button
  padding: 1px;
  background: transparent;
  border-radius: tokens.$size-radius-sm;
  border: none;
}

// Panel toggle button: unified icon version
.bitfun-immersive-toggle-btn {
  @include mix.reset-button;
  @include mix.flex-layout(row, center, center, 1px);
  height: $_panel-btn-size;
  padding: 0 6px;
  border-radius: 4px;
  background: transparent;
  color: var(--color-text-muted);
  @include mix.transition(all, tokens.$motion-fast);
  position: relative;
  overflow: hidden;
  cursor: pointer;

  // Unified icon mode
  &--unified {
    min-width: auto;
    width: auto;
  }

  // Left fill state (left expanded, right collapsed)
  &--left-fill {
    background: transparent;
    
    .bitfun-panel-indicator--right {
      color: var(--color-text-disabled);
    }
  }

  // Right fill state (right expanded, left collapsed)
  &--right-fill {
    background: transparent;
    
    .bitfun-panel-indicator--left {
      color: var(--color-text-disabled);
    }
  }

  // Both sides expanded
  &--both-expanded {
    background: transparent;
  }

  // Both sides collapsed
  &--both-collapsed {
    background: transparent;
    
    .bitfun-panel-indicator--left,
    .bitfun-panel-indicator--right {
      color: var(--color-text-disabled);
    }
  }

}

// Panel indicators (left and right icons)
.bitfun-panel-indicator {
  @include mix.flex-layout(row, center, center);
  padding: 2px;
  border-radius: 2px;
  cursor: pointer;
  @include mix.transition(all, tokens.$motion-fast);
  position: relative;
  background: transparent;

  &:hover {
    background: var(--color-primary-alpha-10);
    color: var(--color-primary);
    transform: scale(1.1);
  }

  &:active {
    background: var(--color-primary-alpha-20);
    transform: scale(1.05);
  }

  // Active state: keep original color
  &.active {
    background: transparent;
    
    &:hover {
      color: var(--color-primary);
      background: var(--color-primary-alpha-10);
      transform: scale(1.1);
    }
  }
  
  // Toolbar mode button
  &--toolbar {
    color: var(--color-text-muted);
  }
}

// Divider
.bitfun-panel-divider {
  width: 1px;
  height: 12px;
  background: tokens.$border-subtle;
  opacity: 0.5;
  @include mix.transition(opacity, tokens.$motion-fast);

  .bitfun-immersive-toggle-btn:hover & {
    opacity: 0.8;
  }
}

// ==================== Responsive design ====================

// Medium screens (max-width: 1024px) - header padding is $size-gap-3
@media (max-width: 1024px) {
  .bitfun-header-right {
    margin-right: calc(-1 * #{tokens.$size-gap-3} + 4px); // Offset header padding with a small margin
  }
}

@include mix.respond-to('mobile') {
  .bitfun-header-left {
    gap: $_header-gap-sm;
  }

  .bitfun-agent-menu-btn {
    width: 20px;
    height: 20px;

    svg {
      width: 13px;
      height: 13px;
    }
  }

  .bitfun-horizontal-menu {
    gap: 1px;
    left: 24px; // Align to menu button on mobile
    padding: 0; // Flat, no padding

    &--visible {
      max-width: 400px;
    }
  }

  .bitfun-horizontal-menu-item {
    padding: 3px 7px;
    font-size: 11px;
    gap: 3px;

    svg {
      width: 13px;
      height: 13px;
    }
  }

  .bitfun-horizontal-menu-divider {
    height: 12px;
  }

  .bitfun-header-center {
    max-width: 480px; // Smaller max width on mobile
    padding: 0 $_header-gap-sm;
  }

  .bitfun-header-right {
    margin-right: calc(-1 * #{tokens.$size-gap-3} + 4px); // Mobile header padding offset with small margin
  }

  .bitfun-immersive-panel-toggles {
    gap: 1px;
    margin-right: 2px; // Reduce right margin on mobile
    padding: 1px;
    background: transparent;
    border: none;
  }

  .bitfun-immersive-toggle-btn {
    height: $_panel-btn-size-mobile;
    padding: 0 3px;
    gap: 1px;
  }

  .bitfun-panel-indicator {
    padding: 1px;

    svg {
      width: 9px;
      height: 9px;
    }
  }

  .bitfun-panel-divider {
    height: 9px;
  }
}

// Small-screen devices
@media (max-width: 480px) {
  .bitfun-horizontal-menu {
    gap: 1px;
    left: 20px; // Align to menu button on small screens
    padding: 0; // Flat, no padding

    &--visible {
      max-width: 300px;
    }
  }

  .bitfun-horizontal-menu-item {
    padding: 2px 5px;
    font-size: 10px;
    gap: 2px;

    svg {
      width: 11px;
      height: 11px;
    }
  }

  .bitfun-horizontal-menu-divider {
    height: 10px;
  }

  .bitfun-header-center {
    max-width: 360px; // Smaller max width on small screens
    padding: 0 tokens.$size-gap-1;
  }

  .bitfun-immersive-panel-toggles {
    gap: 0px;
    margin-right: 2px; // Reduce right margin on small screens
    padding: 1px;
    background: transparent;
    border: none;
  }

  .bitfun-immersive-toggle-btn {
    height: $_panel-btn-size-small;
    padding: 0 2px;
    gap: 1px;
    border-radius: 3px;
  }

  .bitfun-panel-indicator {
    padding: 1px;

    svg {
      width: 8px;
      height: 8px;
    }
  }

  .bitfun-panel-divider {
    height: 7px;
  }
}

// ==================== Accessibility ====================

// High-contrast mode
@media (prefers-contrast: high) {
  .bitfun-app-title-btn {
    border: 1px solid tokens.$border-medium;
  }

  .bitfun-app-title-btn:hover {
    border-color: tokens.$border-strong;
  }

  .bitfun-immersive-toggle-btn {
    border: none;

    &:hover {
      border: none;
    }
  }

  .bitfun-panel-indicator {
    border: none;
  }

  .bitfun-panel-divider {
    opacity: 1;
    background: tokens.$border-strong;
  }

  .bitfun-horizontal-menu-divider {
    opacity: 1;
    background: tokens.$border-strong;
  }
}

// Reduced motion preference
@media (prefers-reduced-motion: reduce) {
  .bitfun-app-title-btn,
  .bitfun-immersive-toggle-btn,
  .bitfun-panel-indicator,
  .bitfun-panel-divider,
  .bitfun-app-icon,
  .bitfun-logo-menu,
  .bitfun-horizontal-menu,
  .bitfun-horizontal-menu-item {
    transition: none;
    animation: none;
  }

  .bitfun-app-title-btn::before,
  .bitfun-app-title-btn::after {
    transition: none;
  }

  .bitfun-horizontal-menu-item,
  .bitfun-horizontal-menu-divider {
    transform: none !important;
    opacity: 1 !important;
  }
}
